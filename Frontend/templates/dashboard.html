<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blood Donation Management System - Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    :root {
      --primary: #e63946;
      --secondary: #457b9d;
      --light: #f1faee;
      --dark: #1d3557;
      --success: #2a9d8f;
      --danger: #e63946;
      --warning: #f4a261;
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
      --border-radius: 15px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--gradient);
      color: white;
      padding: 30px 20px;
      box-shadow: var(--shadow);
      position: relative;
      z-index: 10;
    }

    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
      font-weight: 300;
      letter-spacing: 2px;
    }

    .sidebar nav ul {
      list-style: none;
      padding: 0;
    }

    .sidebar nav ul li {
      margin: 20px 0;
    }

    .sidebar nav ul li a {
      text-decoration: none;
      color: white;
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
    }

    .sidebar nav ul li a:hover {
      background: rgba(255,255,255,0.2);
      transform: translateX(5px);
    }

    .sidebar nav ul li a::before {
      content: "ü©∏";
      margin-right: 10px;
      font-size: 18px;
    }

    .sidebar nav ul li a[href="#inventory"]::before { content: "üìä"; }
    .sidebar nav ul li a[href="#donors"]::before { content: "üë•"; }
    .sidebar nav ul li a[href="#recipients"]::before { content: "üè•"; }

    /* Main content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      color: var(--dark);
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    header h1 {
      font-weight: 300;
      font-size: 28px;
      color: var(--primary);
    }

    /* Profile */
    .user-profile {
      display: flex;
      align-items: center;
      cursor: pointer;
      position: relative;
      padding: 10px 15px;
      border-radius: var(--border-radius);
      transition: all 0.3s ease;
    }

    .user-profile:hover {
      background: rgba(230,57,70,0.1);
    }

    .user-profile img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      margin-right: 12px;
      border: 3px solid var(--primary);
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: 60px;
      right: 0;
      background: white;
      color: var(--dark);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 15px;
      z-index: 100;
      min-width: 150px;
    }

    .dropdown-menu.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-menu button {
      width: 100%;
      padding: 10px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .dropdown-menu button:hover {
      background: var(--danger);
      transform: translateY(-2px);
    }

    /* Dashboard */
    .dashboard {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
      background: transparent;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      grid-template-rows: auto 1fr;
      gap: 30px;
      height: 100%;
    }

    .dashboard-header {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .dashboard-header h2 {
      font-size: 32px;
      font-weight: 300;
      color: var(--dark);
    }

    .refresh-btn {
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .refresh-btn:hover {
      background: var(--danger);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(230,57,70,0.3);
    }

    /* Charts Container */
    .charts-container {
      display: grid;
      grid-template-rows: 1fr 1fr;
      gap: 20px;
    }

    .chart-card {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .chart-card h3 {
      margin-bottom: 20px;
      color: var(--dark);
      font-weight: 400;
      font-size: 18px;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    /* Right Panel */
    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* 3D Visualization */
    .visualization-card {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.2);
      height: 300px;
    }

    #threejs-container {
      width: 100%;
      height: 250px;
      border-radius: 10px;
      overflow: hidden;
    }

    /* Notifications */
    .notifications {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.2);
      flex: 1;
    }

    .notifications h3 {
      margin-bottom: 20px;
      color: var(--dark);
      font-weight: 400;
      display: flex;
      align-items: center;
    }

    .notifications h3::before {
      content: "üîî";
      margin-right: 10px;
    }

    .notification-item {
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 10px;
      background: rgba(230,57,70,0.1);
      border-left: 4px solid var(--primary);
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .notification-footer {
      text-align: center;
      margin-top: 20px;
    }

    .notification-footer a {
      display: inline-block;
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border-radius: var(--border-radius);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .notification-footer a:hover {
      background: var(--danger);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(230,57,70,0.3);
    }

    /* Status indicators */
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-critical { background: var(--danger); }
    .status-warning { background: var(--warning); }
    .status-healthy { background: var(--success); }

    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(230,57,70,0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
      
      .charts-container {
        grid-template-rows: auto;
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: auto;
        padding: 15px;
      }
      
      .charts-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Blood Ninja</h2>
    <nav>
      <ul>
        <li><a href="#dashboard" onclick="showPage('dashboard')">Dashboard</a></li>
        <li><a href="#inventory" onclick="showPage('inventory')">Blood Inventory</a></li>
        <li><a href="#donors" onclick="showPage('donors')">Donors</a></li>
        <li><a href="#recipients" onclick="showPage('recipients')">Recipients</a></li>
      </ul>
    </nav>
  </div>

  <!-- Main -->
  <div class="main">
    <header>
      <h1>Blood Donation Management System</h1>
      <div class="user-profile" id="header-profile">
        <img src="https://via.placeholder.com/45" alt="User Avatar">
        <span id="user-name">Admin</span>
        <div class="dropdown-menu" id="sidebar-menu">
          <p style="margin-bottom: 10px; font-weight: 500;">Profile Settings</p>
         <a href="{{ url_for('adminPanel') }}">
         <button>Admin Panel</button>
         </a>
          <button onclick="alert('Profile settings coming soon!')">Settings</button>
          <button onclick="logout()">Logout</button>
        </div>
      </div>
    </header>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard-page">
      <div class="dashboard-grid">
        <div class="dashboard-header">
          <h2>Dashboard Overview</h2>
          <button class="refresh-btn" onclick="loadInventory()">
            <span id="refresh-icon">üîÑ</span> Refresh Data
          </button>
        </div>

        <div class="charts-container">
          <div class="chart-card">
            <h3>üìä Blood Inventory Levels</h3>
            <div class="chart-wrapper">
              <canvas id="barChart"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <h3>ü©∏ Blood Type Distribution</h3>
            <div class="chart-wrapper">
              <canvas id="pieChart"></canvas>
            </div>
          </div>
        </div>

        <div class="right-panel">
          <div class="visualization-card">
            <h3>üíñ 3D Blood Drop Visualization</h3>
            <div id="threejs-container"></div>
          </div>

          <div class="notifications">
            <h3>Notifications</h3>
            <div id="notification-list">
              <div class="notification-item">
                <span class="status-indicator status-healthy"></span>
                System initialized successfully
              </div>
            </div>
            <div class="notification-footer">
              <a href="Notifications.html">View All Notifications</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let barChart, pieChart;
    let scene, camera, renderer, bloodDrop;
    let inventoryData = [];

    // Authentication check
    function checkAuth() {
const token = localStorage.getItem('token');
localStorage.setItem('token', data.token);
localStorage.setItem('userData', JSON.stringify(data.user));
window.location.href = "/dashboard";

      if (!token) {
        window.location.href = "/index.html";
        return false;
      }
      return true;
    }

    // Sidebar menu toggle
    document.getElementById("header-profile").addEventListener("click", () => {
      document.getElementById("sidebar-menu").classList.toggle("show");
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
      if (!e.target.closest("#header-profile")) {
        document.getElementById("sidebar-menu").classList.remove("show");
      }
    });

    // Logout functionality
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("userData");
      window.location.href = "/login.html";
    }

    // Load Inventory from Flask API
    async function loadInventory() {
      const refreshBtn = document.querySelector('.refresh-btn');
      const refreshIcon = document.getElementById('refresh-icon');
      
      try {
        // Show loading state
        refreshIcon.innerHTML = '<div class="loading"></div>';
        refreshBtn.disabled = true;

        // Fetch from Flask API
        const response = await fetch("/api/inventory", {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        inventoryData = data;

        // Update charts
        updateCharts(data);
        
        // Check for low stock and create notifications
        checkLowStock(data);

        console.log("Inventory loaded successfully:", data);
        
      } catch (error) {
        console.error("Error loading inventory:", error);
        addNotification("‚ùå Failed to load inventory data", "error");
        
        // Fallback demo data for development
        const demoData = [
          { bloodType: 'A+', units: 15 },
          { bloodType: 'B+', units: 8 },
          { bloodType: 'O+', units: 3 },
          { bloodType: 'AB+', units: 12 },
          { bloodType: 'A-', units: 6 },
          { bloodType: 'B-', units: 4 },
          { bloodType: 'O-', units: 2 },
          { bloodType: 'AB-', units: 9 }
        ];
        
        inventoryData = demoData;
        updateCharts(demoData);
        checkLowStock(demoData);
        
      } finally {
        // Reset loading state
        refreshIcon.innerHTML = 'üîÑ';
        refreshBtn.disabled = false;
      }
    }

    // Update charts with new data
    function updateCharts(data) {
      const bloodTypes = data.map(item => item.bloodType);
      const units = data.map(item => item.units);
      const colors = data.map(item => {
        if (item.units < 5) return '#e63946'; // Critical - Red
        if (item.units < 10) return '#f4a261'; // Warning - Orange
        return '#2a9d8f'; // Healthy - Green
      });

      // Update bar chart
      if (barChart) {
        barChart.data.labels = bloodTypes;
        barChart.data.datasets[0].data = units;
        barChart.data.datasets[0].backgroundColor = colors;
        barChart.update('active');
      }

      // Update pie chart
      if (pieChart) {
        pieChart.data.labels = bloodTypes;
        pieChart.data.datasets[0].data = units;
        pieChart.data.datasets[0].backgroundColor = [
          '#e63946', '#f4a261', '#2a9d8f', '#457b9d',
          '#1d3557', '#f1faee', '#264653', '#e76f51'
        ];
        pieChart.update('active');
      }
    }

    // Initialize charts
    function initializeCharts() {
      // Bar Chart
      const barCtx = document.getElementById('barChart').getContext('2d');
      barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Units Available',
            data: [],
            backgroundColor: [],
            borderColor: '#1d3557',
            borderWidth: 2,
            borderRadius: 8,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(29, 53, 87, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#457b9d',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(29, 53, 87, 0.1)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeInOutQuart'
          }
        }
      });

      // Pie Chart
      const pieCtx = document.getElementById('pieChart').getContext('2d');
      pieChart = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: [],
            borderColor: '#fff',
            borderWidth: 3,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(29, 53, 87, 0.9)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: '#457b9d',
              borderWidth: 1
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeInOutQuart'
          }
        }
      });
    }

    // Initialize Three.js 3D visualization
    function initializeThreeJS() {
      const container = document.getElementById('threejs-container');
      
      // Scene setup
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf8f9fa);
      
      // Camera
      camera = new THREE.PerspectiveCamera(75, container.offsetWidth / container.offsetHeight, 0.1, 1000);
      camera.position.z = 5;
      
      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(container.offsetWidth, container.offsetHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      container.appendChild(renderer.domElement);
      
      // Lighting
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(10, 10, 5);
      directionalLight.castShadow = true;
      scene.add(directionalLight);
      
      // Create blood drop geometry (combination of sphere and cone)
      const dropGeometry = new THREE.Group();
      
      // Main drop body (sphere)
      const sphereGeometry = new THREE.SphereGeometry(1, 32, 32);
      const dropMaterial = new THREE.MeshPhongMaterial({ 
        color: 0xe63946,
        shininess: 100,
        transparent: true,
        opacity: 0.9
      });
      const sphere = new THREE.Mesh(sphereGeometry, dropMaterial);
      sphere.position.y = 0.3;
      sphere.castShadow = true;
      dropGeometry.add(sphere);
      
      // Drop tail (cone)
      const coneGeometry = new THREE.ConeGeometry(0.3, 1, 16);
      const cone = new THREE.Mesh(coneGeometry, dropMaterial);
      cone.position.y = -0.8;
      cone.rotation.x = Math.PI;
      cone.castShadow = true;
      dropGeometry.add(cone);
      
      bloodDrop = dropGeometry;
      scene.add(bloodDrop);
      
      // Add floating particles
      const particlesGeometry = new THREE.BufferGeometry();
      const particlesCount = 50;
      const posArray = new Float32Array(particlesCount * 3);
      
      for(let i = 0; i < particlesCount * 3; i++) {
        posArray[i] = (Math.random() - 0.5) * 10;
      }
      
      particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
      
      const particlesMaterial = new THREE.PointsMaterial({
        size: 0.05,
        color: 0xe63946,
        transparent: true,
        opacity: 0.3
      });
      
      const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
      scene.add(particlesMesh);
      
      // Animation loop
      function animate() {
        requestAnimationFrame(animate);
        
        // Rotate blood drop
        if (bloodDrop) {
          bloodDrop.rotation.y += 0.01;
          bloodDrop.rotation.x = Math.sin(Date.now() * 0.001) * 0.1;
        }
        
        // Animate particles
        particlesMesh.rotation.y += 0.001;
        
        renderer.render(scene, camera);
      }
      
      animate();
      
      // Handle window resize
      window.addEventListener('resize', () => {
        if (container.offsetWidth > 0) {
          camera.aspect = container.offsetWidth / container.offsetHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(container.offsetWidth, container.offsetHeight);
        }
      });
    }

    // Check for low stock and add notifications
    function checkLowStock(data) {
      data.forEach(item => {
        if (item.units < 5) {
          addNotification(`üö® Critical: ${item.bloodType} blood level is critically low (${item.units} units)`, "critical");
        } else if (item.units < 10) {
          addNotification(`‚ö†Ô∏è Warning: ${item.bloodType} blood level is running low (${item.units} units)`, "warning");
        }
      });
    }

    // Add notification
    function addNotification(message, type = "info") {
      const list = document.getElementById("notification-list");
      const item = document.createElement("div");
      item.className = "notification-item";
      
      let statusClass = "status-healthy";
      if (type === "critical") statusClass = "status-critical";
      if (type === "warning") statusClass = "status-warning";
      if (type === "error") statusClass = "status-critical";
      
      item.innerHTML = `<span class="status-indicator ${statusClass}"></span>${message}`;
      
      // Add to top of list
      if (list.firstChild) {
        list.insertBefore(item, list.firstChild);
      } else {
        list.appendChild(item);
      }
      
      // Limit to 5 notifications
      while (list.children.length > 5) {
        list.removeChild(list.lastChild);
      }
    }

    // Page navigation (placeholder)
    function showPage(page) {
      console.log(`Navigating to ${page} page`);
      // Add your page navigation logic here
    }

    // Auto-refresh every 30 seconds
    setInterval(() => {
      if (document.visibilityState === 'visible') {
        loadInventory();
      }
    }, 30000);

    // Initialize everything when page loads
    window.onload = () => {
      if (!checkAuth()) return;
      
      // Initialize visualizations
      initializeCharts();
      initializeThreeJS();
      
      // Load initial data
      loadInventory();
      
      // Add welcome notification
      setTimeout(() => {
        addNotification("‚úÖ Dashboard initialized successfully", "info");
      }, 1000);
    };

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        loadInventory();
      }
    });
  </script>
</body>
</html>
