@app.route('/api/auth/login', methods=['POST'])
def login():
    data = request.get_json()
    
    if not data or not data.get('email') or not data.get('password'):
        return jsonify({'message': 'Missing credentials'}), 400
    
    user = User.query.filter_by(email=data['email']).first()
    
    if not user or not check_password_hash(user.password, data['password']):
        return jsonify({'message': 'Invalid email or password'}), 401

    token = jwt.encode(
        {'user_id': user.id, 'email': user.email, 'exp': datetime.datetime.utcnow() + datetime.timedelta(hours=24)},
        SECRET_KEY,
        algorithm='HS256'
    )
    token = token if isinstance(token, str) else token.decode('utf-8')

    # Generate avatar dynamically
    avatar_url = generate_avatar(user.email, user.name)
    
    # Send notification
    send_notification(user, f"Hello {user.name}, you just logged in successfully.")
    
    return jsonify({
        'token': token,
        'user': {
            'id': user.id,
            'name': user.name,
            'email': user.email,
            'avatar': avatar_url  # <-- dynamic avatar included
        }
    }), 200